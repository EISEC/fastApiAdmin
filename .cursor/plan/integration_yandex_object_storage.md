# Интеграция с Яндекс Облако (Object Storage)

## 1. Регистрация в Яндекс Облаке
1. Перейдите на сайт: https://cloud.yandex.ru/
2. Зарегистрируйтесь или войдите в свой аккаунт Яндекса.
3. Создайте облако и каталог (если еще не созданы).

## 2. Создание сервисного аккаунта и получение IAM-ключей
1. В панели управления выберите ваш каталог.
2. Перейдите в раздел "Сервисные аккаунты".
3. Нажмите "Создать сервисный аккаунт". Укажите имя (например, `object-storage-uploader`).
4. После создания выберите сервисный аккаунт и перейдите на вкладку "Ключи доступа".
5. Нажмите "Создать новый ключ". Скачайте файл с ключами (он содержит `access_key_id` и `secret_access_key`).
6. Назначьте сервисному аккаунту роль "storage.editor" или "storage.admin".

## 3. Создание бакета (bucket)
1. В панели управления выберите "Object Storage".
2. Нажмите "Создать бакет".
3. Укажите имя бакета (например, `my-app-media`).
4. Выберите регион (например, `ru-central1`).
5. Оставьте остальные настройки по умолчанию или настройте по необходимости.
6. После создания бакета скопируйте его имя и endpoint (например, `https://storage.yandexcloud.net`).

## 4. Где найти endpoint и регион
- Endpoint для большинства регионов: `https://storage.yandexcloud.net`
- Регион: `ru-central1` (или другой, если выбрали иной при создании бакета)

## 5. Итоговые данные для интеграции
- `AWS_ACCESS_KEY_ID` — из файла ключей
- `AWS_SECRET_ACCESS_KEY` — из файла ключей
- `AWS_STORAGE_BUCKET_NAME` — имя бакета
- `AWS_S3_ENDPOINT_URL` — endpoint (обычно `https://storage.yandexcloud.net`)
- `AWS_S3_REGION_NAME` — регион (например, `ru-central1`)

---

**Дальнейшие шаги:**
- Настроить Django для работы с этими параметрами (см. следующий раздел плана)
- Добавить UI для ввода этих данных в настройках сайта (если требуется)

> Для безопасности: не публикуйте секретные ключи в публичных репозиториях!

---

## 6. Настройка Django для работы с Яндекс Object Storage

### 6.1. Установка зависимостей

Выполните в папке backend:
```bash
python3 -m pip install django-storages boto3
```

Добавьте `'storages'` в `INSTALLED_APPS` в вашем `settings.py`.

### 6.2. Конфигурация settings.py

Добавьте в настройки (используйте переменные окружения!):
```python
# settings.py
import os

AWS_ACCESS_KEY_ID = os.getenv('AWS_ACCESS_KEY_ID')
AWS_SECRET_ACCESS_KEY = os.getenv('AWS_SECRET_ACCESS_KEY')
AWS_STORAGE_BUCKET_NAME = os.getenv('AWS_STORAGE_BUCKET_NAME')
AWS_S3_ENDPOINT_URL = os.getenv('AWS_S3_ENDPOINT_URL', 'https://storage.yandexcloud.net')
AWS_S3_REGION_NAME = os.getenv('AWS_S3_REGION_NAME', 'ru-central1')
AWS_S3_USE_SSL = True
AWS_S3_ADDRESSING_STYLE = "virtual"
AWS_DEFAULT_ACL = None

DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'

# Для статики (если нужно):
# STATICFILES_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
```

### 6.3. Проверка загрузки файлов
- Проверьте загрузку файлов через Django admin или API.
- Убедитесь, что файлы появляются в бакете Яндекс Облака.

### 6.4. Best practices
- **Не храните ключи в репозитории!** Используйте `.env` или переменные окружения.
- Для каждого сайта используйте отдельный бакет или префикс (если требуется изоляция).
- Ограничьте права сервисного аккаунта только необходимыми (storage.editor).
- Настройте CORS в Object Storage, если файлы будут доступны с фронтенда.
- Для больших файлов используйте multipart upload (поддерживается boto3).

---

**Следующий шаг:**
- Добавить UI для ввода ключей/бакета в настройках сайта (если требуется)
- Реализовать динамическое подключение к разным бакетам/ключам (опционально)

## 7. UI и настройки для ввода ключей/бакета пользователем

### 7.1. UI для админки и сайтов
- В настройках сайта (и/или панели администратора) добавить поля:
    - `Object Storage Access Key`
    - `Object Storage Secret Key`
    - `Bucket Name`
    - `Endpoint` (по умолчанию `https://storage.yandexcloud.net`)
    - `Region` (по умолчанию `ru-central1`)
- Для безопасности скрывать секретный ключ (input type="password")
- Добавить кнопку "Проверить подключение" — тестовая загрузка файла и удаление
- Валидация: все поля обязательны, кроме endpoint/region (если дефолтные)

### 7.2. Backend: динамическое подключение
- При загрузке файлов определять, есть ли у сайта свои ключи/бакет
    - Если да — использовать их для инициализации S3 storage (через кастомный storage backend или динамическую настройку)
    - Если нет — использовать глобальные настройки
- Для каждого сайта хранить ключи/бакет в отдельной модели (например, `SiteStorageSettings`)
- При сохранении настроек — валидировать ключи (тестовая операция)

### 7.3. Пример структуры модели (Django)
```python
class SiteStorageSettings(models.Model):
    site = models.OneToOneField(Site, on_delete=models.CASCADE)
    access_key = models.CharField(max_length=128)
    secret_key = models.CharField(max_length=128)
    bucket_name = models.CharField(max_length=128)
    endpoint = models.CharField(max_length=256, default='https://storage.yandexcloud.net')
    region = models.CharField(max_length=64, default='ru-central1')
    updated_at = models.DateTimeField(auto_now=True)
```

### 7.4. UI/UX рекомендации
- Показывать статус подключения (успешно/ошибка)
- Не хранить секретные ключи в localStorage или на фронте
- Дать пользователю возможность сбросить настройки к дефолтным

---

**Следующий шаг:**
- Реализовать документацию и best practices по использованию Object Storage в проекте 

## 8. Документация и best practices по Object Storage

### 8.1. Структура документации
- Описание назначения интеграции
- Пошаговая инструкция по регистрации и настройке (см. выше)
- Пример конфигурации Django
- Описание UI для ввода ключей/бакета
- Пример модели и API для хранения ключей
- Примеры кода загрузки/удаления файлов
- Troubleshooting и FAQ
- Best practices по безопасности и производительности

### 8.2. Best practices
- **Безопасность:**
    - Не хранить секретные ключи в репозитории или на фронте
    - Использовать переменные окружения и защищённые хранилища
    - Ограничивать права сервисного аккаунта (минимально необходимые)
    - Регулярно менять ключи и удалять неиспользуемые
- **Производительность:**
    - Для больших файлов использовать multipart upload
    - Использовать CDN/кеширование для публичных файлов
    - Настроить CORS для доступа с фронтенда
- **Резервное копирование:**
    - Настроить автоматическое резервное копирование бакета (через Яндекс.Облако или внешние инструменты)
- **Мониторинг:**
    - Следить за лимитами и квотами бакета
    - Настроить алерты на превышение лимитов

### 8.3. FAQ и типовые ошибки
- Ошибка авторизации: проверьте правильность ключей и прав сервисного аккаунта
- Файл не появляется в бакете: проверьте настройки бакета и endpoint
- Проблемы с CORS: настройте разрешённые origin в Object Storage
- Ошибка "SignatureDoesNotMatch": проверьте регион и endpoint

---

**После завершения интеграции:**
- Пометить все пункты как [x] в основном плане
- Сформировать отдельный md-файл с документацией для пользователей и разработчиков 